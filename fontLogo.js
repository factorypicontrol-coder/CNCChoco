// Logo, mocked into a letter to fit into the printing mechanisms.

const CHAR_HEIGHT = 15; // matches actual glyph Y extent (0â€“15)

// Example glyph set: you will replace/extend these with your full glyph G-code.
const characters = {
  '?': {
    width: 39,
    gcode: `
      G00 Z5.000000
G00 X1.972932 Y15.000000
G01 Z-0.125000 F100.0
G01 X1.972932 Y6.774752 Z-0.125000 F400.000000
G01 X0.000000 Y0.203180 Z-0.125000
G01 X1.826259 Y0.203180 Z-0.125000
G02 X1.855292 Y0.316881 Z-0.125000 I1.419485 J-0.301900
G02 X2.645797 Y2.954175 Z-0.125000 I1701.383399 J-508.537413
G01 X3.980053 Y2.954175 Z-0.125000
G01 X5.090775 Y0.203180 Z-0.125000
G01 X7.079804 Y0.203180 Z-0.125000
G01 X5.791046 Y2.954175 Z-0.125000
G01 X9.318542 Y2.954175 Z-0.125000
G01 X8.488894 Y0.203412 Z-0.125000
G01 X10.164555 Y0.203412 Z-0.125000
G01 X11.126609 Y3.421067 Z-0.125000
G01 X11.412404 Y3.421268 Z-0.125000
G01 X11.412404 Y2.954175 Z-0.125000
G01 X16.760971 Y2.954175 Z-0.125000
G01 X15.919648 Y0.207803 Z-0.125000
G01 X17.450200 Y0.207803 Z-0.125000
G01 X18.263419 Y2.954175 Z-0.125000
G01 X19.771155 Y2.954175 Z-0.125000
G01 X19.937051 Y0.207803 Z-0.125000
G01 X21.522813 Y0.207803 Z-0.125000
G01 X23.297488 Y2.954175 Z-0.125000
G01 X24.772562 Y2.954175 Z-0.125000
G01 X23.956018 Y0.207803 Z-0.125000
G01 X25.845004 Y0.207803 Z-0.125000
G01 X26.529377 Y2.954175 Z-0.125000
G01 X28.109650 Y2.954175 Z-0.125000
G03 X29.475680 Y0.522287 Z-0.125000 I2.790129 J-0.032345
G03 X31.379056 Y0.000000 Z-0.125000 I1.903376 J3.207104
G03 X33.519282 Y0.125770 Z-0.125000 I0.000000 J18.272997
G03 X34.460249 Y0.363289 Z-0.125000 I-0.438884 J3.721352
G01 X35.187326 Y2.954175 Z-0.125000
G01 X38.815332 Y2.954175 Z-0.125000
G01 X38.815332 Y15.000000 Z-0.125000
G01 X30.291117 Y15.000000 Z-0.125000
G01 X30.291117 Y7.644312 Z-0.125000
G03 X29.849019 Y7.224884 Z-0.125000 I2.546776 J-3.127138
G03 X29.375859 Y6.619065 Z-0.125000 I3.904430 J-3.537139
G01 X29.375859 Y15.000000 Z-0.125000
G01 X20.851644 Y15.000000 Z-0.125000
G01 X20.851644 Y8.351068 Z-0.125000
G01 X19.936852 Y8.351068 Z-0.125000
G01 X19.936852 Y15.000000 Z-0.125000
G01 X11.412404 Y15.000000 Z-0.125000
G01 X11.412404 Y8.350636 Z-0.125000
G01 X10.946145 Y8.350636 Z-0.125000
G01 X10.497379 Y6.862722 Z-0.125000
G01 X10.497379 Y15.000000 Z-0.125000
G01 X1.972932 Y15.000000 Z-0.125000
G01 X1.972932 Y15.000000 Z-0.125000
G00 Z5.000000
G00 X2.279248 Y14.693883
G01 Z-0.125000 F100.0
G01 X10.191029 Y14.693883 Z-0.125000 F400.000000
G01 X10.191029 Y5.846987 Z-0.125000
G01 X9.411003 Y3.260726 Z-0.125000
G01 X5.647466 Y3.260726 Z-0.125000
G01 X5.028947 Y4.581012 Z-0.125000
G01 X9.063578 Y8.349738 Z-0.125000
G01 X6.819884 Y8.349738 Z-0.125000
G01 X3.253474 Y4.753761 Z-0.125000
G01 X3.856296 Y3.260726 Z-0.125000
G01 X2.737958 Y3.260726 Z-0.125000
G01 X4.272268 Y8.349738 Z-0.125000
G01 X2.445777 Y8.349738 Z-0.125000
G01 X2.279248 Y7.795042 Z-0.125000
G01 X2.279248 Y14.693883 Z-0.125000
G01 X2.279248 Y14.693883 Z-0.125000
G00 Z5.000000
G00 X11.718721 Y14.693883
G01 Z-0.125000 F100.0
G01 X19.630070 Y14.693883 Z-0.125000 F400.000000
G01 X19.630070 Y8.351068 Z-0.125000
G01 X18.414249 Y8.351068 Z-0.125000
G01 X16.854961 Y3.260958 Z-0.125000
G01 X11.718721 Y3.260958 Z-0.125000
G01 X11.718721 Y3.421466 Z-0.125000
G01 X12.467218 Y3.421966 Z-0.125000
G03 X15.587577 Y4.472831 Z-0.125000 I0.005239 J5.142555
G03 X16.460109 Y5.891356 Z-0.125000 I-1.399793 J1.838618
G03 X16.261530 Y7.440818 Z-0.125000 I-2.516596 J0.464929
G03 X15.619385 Y8.070961 Z-0.125000 I-1.165255 J-0.545189
G03 X14.496763 Y8.331737 Z-0.125000 I-1.237441 J-2.780303
G03 X13.022013 Y8.350636 Z-0.125000 I-1.116422 J-29.569287
G01 X11.718721 Y8.350636 Z-0.125000
G01 X11.718721 Y14.693883 Z-0.125000
G01 X11.718721 Y14.693883 Z-0.125000
G00 Z5.000000
G00 X13.436156 Y7.180413
G01 Z-0.125000 F100.0
G02 X14.481222 Y6.821310 Z-0.125000 I-0.039836 J-1.816167 F400.000000
G02 X14.773838 Y5.891157 Z-0.125000 I-0.496966 J-0.667443
G02 X14.199970 Y5.077426 Z-0.125000 I-1.635409 J0.544121
G02 X12.898322 Y4.615702 Z-0.125000 I-1.341324 J1.715729
G02 X12.313239 Y4.613280 Z-0.125000 I-0.377272 J20.461453
G03 X11.443302 Y4.617697 Z-0.125000 I-0.869936 J-85.665388
G01 X12.190036 Y7.178085 Z-0.125000
G03 X12.883656 Y7.182920 Z-0.125000 I-0.063734 J58.904165
G02 X13.436156 Y7.180413 Z-0.125000 I0.204209 J-15.881334
G01 X13.436156 Y7.180413 Z-0.125000
G00 Z5.000000
G00 X19.515658 Y7.183174
G01 Z-0.125000 F100.0
G01 X19.752596 Y3.260958 Z-0.125000 F400.000000
G01 X18.354249 Y3.260958 Z-0.125000
G01 X19.515658 Y7.183174 Z-0.125000
G01 X19.515658 Y7.183174 Z-0.125000
G00 Z5.000000
G00 X21.261529 Y2.954175
G01 Z-0.125000 F100.0
G01 X21.866846 Y2.954175 Z-0.125000 F400.000000
G01 X21.156863 Y1.306352 Z-0.125000
G03 X21.223164 Y2.090956 Z-0.125000 I-16.649086 J1.801996
G03 X21.261529 Y2.954175 Z-0.125000 I-26.336329 J1.602976
G01 X21.261529 Y2.954175 Z-0.125000
G00 Z5.000000
G00 X26.029659 Y7.182276
G01 Z-0.125000 F100.0
G01 X24.863693 Y3.260726 Z-0.125000 F400.000000
G01 X23.495578 Y3.260726 Z-0.125000
G01 X26.029659 Y7.182276 Z-0.125000
G01 X26.029659 Y7.182276 Z-0.125000
G00 Z5.000000
G00 X30.291117 Y4.960000
G01 Z-0.125000 F100.0
G01 X30.291117 Y2.954175 Z-0.125000 F400.000000
G01 X33.505213 Y2.954175 Z-0.125000
G01 X33.032168 Y1.462936 Z-0.125000
G02 X32.832754 Y1.196058 Z-0.125000 I-0.206538 J-0.053614
G02 X31.733299 Y1.175843 Z-0.125000 I-1.223314 J36.624255
G02 X30.609566 Y1.449081 Z-0.125000 I-0.008640 J2.411845
G02 X30.054443 Y2.022060 Z-0.125000 I0.585225 J1.122388
G02 X29.870540 Y2.873047 Z-0.125000 I1.676287 J0.807620
G02 X30.097616 Y4.357080 Z-0.125000 I5.854964 J-0.136497
G02 X30.192625 Y4.669608 Z-0.125000 I10.610999 J-3.055030
G02 X30.291117 Y4.960000 Z-0.125000 I8.549320 J-2.737766
G01 X30.291117 Y4.960000 Z-0.125000
G00 Z5.000000
G00 X30.597433 Y14.693883
G01 Z-0.125000 F100.0
G01 X38.509016 Y14.693883 Z-0.125000 F400.000000
G01 X38.509016 Y3.260726 Z-0.125000
G01 X35.273335 Y3.260726 Z-0.125000
G01 X35.614673 Y4.477013 Z-0.125000
G01 X32.162441 Y4.477013 Z-0.125000
G01 X31.783155 Y3.260726 Z-0.125000
G01 X30.597433 Y3.260726 Z-0.125000
G01 X30.597433 Y5.688376 Z-0.125000
G02 X31.615282 Y6.913805 Z-0.125000 I3.097036 J-1.536988
G02 X33.019595 Y7.346809 Z-0.125000 I1.302490 J-1.730494
G02 X34.103842 Y6.904062 Z-0.125000 I-0.083161 J-1.752641
G02 X34.379196 Y5.933760 Z-0.125000 I-0.625359 J-0.701687
G03 X34.354133 Y5.827249 Z-0.125000 I0.864240 J-0.259567
G02 X34.323520 Y5.731912 Z-0.125000 I-0.352917 J0.060740
G01 X35.997618 Y5.729716 Z-0.125000
G03 X35.747652 Y7.257877 Z-0.125000 I-1.544883 J0.531822
G03 X33.178608 Y8.522685 Z-0.125000 I-2.569044 J-1.976681
G03 X31.979058 Y8.418289 Z-0.125000 I0.000000 J-6.943871
G03 X30.597433 Y7.869343 Z-0.125000 I0.632107 J-3.604082
G01 X30.597433 Y14.693883 Z-0.125000
G01 X30.597433 Y14.693883 Z-0.125000
G00 Z5.000000
G00 X21.157960 Y14.693883
G01 Z-0.125000 F100.0
G01 X29.069976 Y14.693883 Z-0.125000 F400.000000
G01 X29.069976 Y6.111299 Z-0.125000
G03 X28.710861 Y5.355483 Z-0.125000 I6.821732 J-3.704466
G03 X28.337841 Y4.308920 Z-0.125000 I10.880539 J-4.467845
G03 X28.194115 Y3.736814 Z-0.125000 I5.757502 J-1.750513
G03 X28.125415 Y3.260726 Z-0.125000 I4.387363 J-0.876106
G01 X26.605774 Y3.260726 Z-0.125000
G01 X27.874242 Y8.351068 Z-0.125000
G01 X25.197681 Y8.351068 Z-0.125000
G03 X22.991757 Y5.007428 Z-0.125000 I39.426640 J-28.410705
G03 X22.020936 Y3.260726 Z-0.125000 I24.689961 J-14.865884
G01 X21.268548 Y3.260726 Z-0.125000
G03 X21.242558 Y5.548861 Z-0.125000 I-39.138104 J0.699663
G03 X21.157960 Y7.132886 Z-0.125000 I-62.082743 J-2.521385
G01 X21.157960 Y14.693883 Z-0.125000
G01 X21.157960 Y14.693883 Z-0.125000
G00 Z5.000000
G00 X3.253474 Y4.753761
G01 Z-0.125000 F100.0
G01 X3.251246 Y4.759249 Z-0.125000 F400.000000
G01 X3.252177 Y4.752464 Z-0.125000
G01 X3.253474 Y4.753761 Z-0.125000
G01 X3.253474 Y4.753761 Z-0.125000
G00 Z5.000000
G00 X3.252177 Y4.752464
G01 Z-0.125000 F100.0
G01 X3.251013 Y4.751300 Z-0.125000 F400.000000
G01 X3.252344 Y4.751300 Z-0.125000
G01 X3.252177 Y4.752464 Z-0.125000
G01 X3.252177 Y4.752464 Z-0.125000
G00 Z5.000000
    `
  }
};


function getCharacter(char) {
  if (characters[char]) return characters[char];
  console.warn(`[fontLogo] Missing glyph for character: "${char}" (U+${char.charCodeAt(0).toString(16).padStart(4, '0')})`);
  return { width: characters[' '] ? characters[' '].width : 5, gcode: '' };
}

function getTextWidth(text, fontSize) {
  const scale = fontSize / CHAR_HEIGHT;
  let w = 0;
  for (const ch of text) w += getCharacter(ch).width * scale;
  return w;
}

// --- G-code parsing / transforming ---
function fmt(n, dp) {
  const v = Number(n);
  if (!Number.isFinite(v)) return (0).toFixed(dp);
  return v.toFixed(dp);
}

function transformGcode(gcodeStr, scale, dx, dy, opts = {}) {
  const {
    decimals = 6,
    normalizeZ = false,
    zSafe = 5,
    zEngrave = -0.125,
    normalizeFeed = false,
    feedRate = 400
  } = opts;

  const lines = (gcodeStr || '').split('\n');
  const out = [];

  for (let raw of lines) {
    const line = raw.trim();
    if (!line) continue;
    if (line.startsWith(';')) { out.push(line); continue; }

    // Tokenize: split by whitespace, keep words like G02, X1.23, I0.5
    const parts = line.split(/\s+/);
    let gWord = null;
    const words = [];

    for (const p of parts) {
      const letter = p[0].toUpperCase();
      const valStr = p.slice(1);

      if (letter === 'G') {
        gWord = `G${valStr.replace(/^0+/, '') || '0'}`; // normalize G00/G0
        words.push(gWord);
        continue;
      }

      // Non-parameter tokens just pass through
      if (!'XYZIJF'.includes(letter)) {
        words.push(p);
        continue;
      }

      const v = Number(valStr);
      if (!Number.isFinite(v)) { words.push(p); continue; }

      if (letter === 'X') {
        words.push(`X${fmt(dx + v * scale, decimals)}`);
      } else if (letter === 'Y') {
        words.push(`Y${fmt(dy + v * scale, decimals)}`);
      } else if (letter === 'I') {
        words.push(`I${fmt(v * scale, decimals)}`);
      } else if (letter === 'J') {
        words.push(`J${fmt(v * scale, decimals)}`);
      } else if (letter === 'Z') {
        if (normalizeZ) {
          // heuristic: Z >= 0 treated as safe, otherwise engrave depth
          words.push(`Z${fmt(v >= 0 ? zSafe : zEngrave, decimals)}`);
        } else {
          words.push(`Z${fmt(v, decimals)}`);
        }
      } else if (letter === 'F') {
        if (normalizeFeed) {
          words.push(`F${fmt(feedRate, decimals)}`);
        } else {
          // preserve glyph feed if provided
          words.push(`F${fmt(v, decimals)}`);
        }
      }
    }

    // If cutting move with no feed and normalizeFeed enabled, add F
    if (normalizeFeed && gWord && (gWord === 'G1' || gWord === 'G01' || gWord === 'G2' || gWord === 'G02' || gWord === 'G3' || gWord === 'G03')) {
      if (!words.some(w => w.toUpperCase().startsWith('F'))) {
        words.push(`F${fmt(feedRate, decimals)}`);
      }
    }

    out.push(words.join(' '));
  }

  return out;
}

function getCharAdvance(char) {
  return getCharacter(char).width;
}

// Render one character at a specific placement
function renderCharGcode(char, fontSize, offsetX, offsetY, opts = {}) {
  const glyph = getCharacter(char);
  const scale = fontSize / CHAR_HEIGHT;
  return transformGcode(glyph.gcode, scale, offsetX, offsetY, opts);
}

module.exports = {
  CHAR_HEIGHT,
  getCharacter,
  getCharAdvance,
  getTextWidth,
  renderCharGcode,
  name: 'logo'
};